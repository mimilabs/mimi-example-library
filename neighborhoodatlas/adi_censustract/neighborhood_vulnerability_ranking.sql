-- adi_neighborhood_social_vulnerability_ranking.sql
-- Business Purpose: Identify and rank census tracts with the highest social vulnerability to inform targeted healthcare resource allocation and intervention strategies

WITH ranked_census_tracts AS (
    -- Rank census tracts by national ADI to highlight most socioeconomically vulnerable areas
    SELECT 
        fips_censustract,
        adi_natrank_avg,
        adi_staternk_avg,
        -- Create percentile ranking to normalize ADI scores
        PERCENT_RANK() OVER (ORDER BY adi_natrank_avg) AS national_vulnerability_percentile,
        PERCENT_RANK() OVER (ORDER BY adi_staternk_avg) AS state_vulnerability_percentile
    FROM mimi_ws_1.neighborhoodatlas.adi_censustract
    WHERE mimi_src_file_date = (SELECT MAX(mimi_src_file_date) FROM mimi_ws_1.neighborhoodatlas.adi_censustract)
),

vulnerability_insights AS (
    -- Categorize census tracts into vulnerability tiers
    SELECT 
        fips_censustract,
        adi_natrank_avg,
        adi_staternk_avg,
        national_vulnerability_percentile,
        state_vulnerability_percentile,
        CASE 
            WHEN national_vulnerability_percentile >= 0.9 THEN 'Extreme Vulnerability'
            WHEN national_vulnerability_percentile >= 0.75 THEN 'High Vulnerability'
            WHEN national_vulnerability_percentile >= 0.5 THEN 'Moderate Vulnerability'
            ELSE 'Lower Vulnerability'
        END AS vulnerability_category
    FROM ranked_census_tracts
)

-- Primary query to surface actionable neighborhood vulnerability insights
SELECT 
    vulnerability_category,
    COUNT(DISTINCT fips_censustract) AS tract_count,
    AVG(adi_natrank_avg) AS avg_national_vulnerability,
    AVG(adi_staternk_avg) AS avg_state_vulnerability
FROM vulnerability_insights
GROUP BY vulnerability_category
ORDER BY avg_national_vulnerability DESC;

-- Query Mechanics:
-- 1. Identifies most recent data snapshot
-- 2. Calculates percentile rankings of census tracts by ADI
-- 3. Categorizes tracts into vulnerability tiers
-- 4. Aggregates insights by vulnerability category

-- Key Assumptions:
-- - Most recent data snapshot represents current socioeconomic conditions
-- - National and state ADI rankings provide comparable vulnerability assessments
-- - Percentile rankings offer normalized view of socioeconomic disadvantage

-- Potential Extensions:
-- 1. Join with healthcare utilization data to correlate vulnerability with service access
-- 2. Integrate geographic visualization for spatial vulnerability analysis
-- 3. Create predictive models for resource allocation based on vulnerability tiers

/*

    - Author: claude-3-5-haiku-20241022
    - Created At: 2024-11-05T22:04:41.874075
    - Additional Notes: Query provides a high-level analysis of census tract socioeconomic vulnerability, categorizing areas by national and state ADI percentile rankings. Useful for initial social risk assessment and targeted intervention planning.
    
    */