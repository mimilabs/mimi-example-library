-- State-Level Social Vulnerability Hot Spots and Risk Assessment
-- Business Purpose:
-- This query identifies states with the highest concentration of socially vulnerable counties
-- to help organizations:
-- 1. Prioritize resource allocation and disaster preparedness at the state level
-- 2. Identify states needing additional federal/organizational support
-- 3. Support strategic planning for multi-state disaster response initiatives

WITH latest_year AS (
  SELECT MAX(year) as max_year
  FROM mimi_ws_1.cdc.svi_county_multiyears
),

state_vulnerability AS (
  SELECT 
    m.state_abbr,
    -- Calculate percentage of high-risk counties (top quartile SVI)
    COUNT(CASE WHEN m.svi >= 0.75 THEN 1 END) * 100.0 / COUNT(*) as pct_high_risk_counties,
    -- Calculate average vulnerability scores
    AVG(m.rpl_socioeconomic) as avg_socioeconomic,
    AVG(m.rpl_householdcomp) as avg_household,
    AVG(m.rpl_minoritystatus) as avg_minority,
    AVG(m.rpl_housingtransport) as avg_housing,
    COUNT(*) as total_counties
  FROM mimi_ws_1.cdc.svi_county_multiyears m
  JOIN latest_year ly ON m.year = ly.max_year
  GROUP BY m.state_abbr
)

SELECT 
  state_abbr,
  ROUND(pct_high_risk_counties, 1) as pct_high_risk_counties,
  ROUND(avg_socioeconomic, 3) as avg_socioeconomic_risk,
  ROUND(avg_household, 3) as avg_household_risk,
  ROUND(avg_minority, 3) as avg_minority_risk,
  ROUND(avg_housing, 3) as avg_housing_risk,
  total_counties
FROM state_vulnerability
WHERE pct_high_risk_counties >= 25  -- Focus on states with significant vulnerability
ORDER BY pct_high_risk_counties DESC;

-- How it works:
-- 1. Identifies the most recent year in the dataset
-- 2. Calculates state-level metrics including:
--    - Percentage of counties with high vulnerability (SVI >= 0.75)
--    - Average risk scores across all vulnerability domains
-- 3. Filters to show states where at least 25% of counties are high-risk
-- 4. Orders results by percentage of high-risk counties

-- Assumptions and Limitations:
-- - Uses most recent year data only
-- - Defines high-risk as top quartile (SVI >= 0.75)
-- - State-level aggregation may mask county-level variations
-- - Equal weighting given to all counties regardless of population

-- Possible Extensions:
-- 1. Add year-over-year comparison to identify trending risks
-- 2. Include population weighting for more accurate state-level assessment
-- 3. Add geographic region grouping for regional analysis
-- 4. Incorporate additional risk factors or demographic data
-- 5. Create risk tier classifications based on multiple metrics

/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-11-03T13:56:26.821095
    - Additional Notes: Query focuses on identifying states with concentrated vulnerability based on county-level SVI data. Results highlight states where 25% or more counties are in the top quartile for social vulnerability, making it particularly useful for state-level policy planning and resource allocation. The analysis uses the most recent year's data only, which should be considered when making long-term planning decisions.
    
    */