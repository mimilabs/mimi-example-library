-- svi_vulnerability_changes.sql

-- Business Purpose:
-- Identifies census tracts that experienced significant changes in social vulnerability
-- over time. This helps healthcare organizations and community planners understand
-- which areas are becoming more or less vulnerable, enabling proactive intervention
-- and resource allocation before crisis situations occur.

WITH tract_changes AS (
  SELECT 
    t1.fips,
    t1.state_abbr,
    t1.county_name,
    t1.year as current_year,
    t1.svi as current_svi,
    LAG(t1.svi, 1) OVER (PARTITION BY t1.fips ORDER BY t1.year) as previous_svi,
    LAG(t1.year, 1) OVER (PARTITION BY t1.fips ORDER BY t1.year) as previous_year,
    (t1.svi - LAG(t1.svi, 1) OVER (PARTITION BY t1.fips ORDER BY t1.year)) as svi_change
  FROM mimi_ws_1.cdc.svi_censustract_multiyears t1
)

SELECT 
  state_abbr,
  county_name,
  fips,
  current_year,
  previous_year,
  ROUND(current_svi, 3) as current_svi,
  ROUND(previous_svi, 3) as previous_svi,
  ROUND(svi_change, 3) as svi_change,
  -- Categorize the magnitude of change
  CASE 
    WHEN svi_change >= 0.2 THEN 'Significant Increase'
    WHEN svi_change <= -0.2 THEN 'Significant Decrease'
    ELSE 'Stable'
  END as change_category
FROM tract_changes
WHERE svi_change IS NOT NULL
  AND ABS(svi_change) >= 0.1  -- Focus on meaningful changes
ORDER BY ABS(svi_change) DESC
LIMIT 100;

-- How it works:
-- 1. Creates a CTE that calculates year-over-year changes in SVI scores for each census tract
-- 2. Uses LAG function to compare current SVI scores with previous period
-- 3. Categorizes changes based on magnitude
-- 4. Filters for meaningful changes and orders by absolute change magnitude

-- Assumptions and Limitations:
-- - Assumes linear progression between measurement periods
-- - Does not account for changes in census tract boundaries over time
-- - Threshold of 0.1 for "meaningful" change is arbitrary and may need adjustment
-- - Limited to top 100 most changed tracts for manageability

-- Possible Extensions:
-- 1. Add drill-down into specific vulnerability domains (rpl_socioeconomic, rpl_householdcomp, etc.)
-- 2. Include population-weighted analysis to prioritize changes affecting more people
-- 3. Add geographic clustering analysis to identify regions with concentrated changes
-- 4. Incorporate year-over-year change patterns across multiple consecutive periods
-- 5. Create summary statistics by state or county to identify broader trends

/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-11-03T13:30:38.802075
    - Additional Notes: Query focuses on detecting substantial changes in vulnerability scores between measurement periods, particularly useful for identifying emerging high-risk areas or successful intervention outcomes. The 0.1 threshold for change significance and 100-row limit may need adjustment based on specific analysis needs.
    
    */