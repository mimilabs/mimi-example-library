-- vulnerability_domain_analysis.sql

-- Business Purpose:
-- Identifies census tracts where multiple SVI domain scores are significantly above average,
-- but the total SVI score remains moderate. This reveals potentially overlooked high-risk
-- areas that warrant closer attention from healthcare organizations and emergency planners.

WITH domain_stats AS (
  -- Calculate average scores for each vulnerability domain across all years
  SELECT 
    AVG(rpl_socioeconomic) as avg_socio,
    AVG(rpl_householdcomp) as avg_household,
    AVG(rpl_minoritystatus) as avg_minority,
    AVG(rpl_housingtransport) as avg_housing
  FROM mimi_ws_1.cdc.svi_censustract_multiyears
),

high_domain_tracts AS (
  -- Identify tracts with multiple high domain scores but moderate overall SVI
  SELECT 
    fips,
    state_abbr,
    county_name,
    year,
    svi,
    -- Count how many domains are significantly above average
    (CASE WHEN rpl_socioeconomic > 0.75 THEN 1 ELSE 0 END +
     CASE WHEN rpl_householdcomp > 0.75 THEN 1 ELSE 0 END +
     CASE WHEN rpl_minoritystatus > 0.75 THEN 1 ELSE 0 END +
     CASE WHEN rpl_housingtransport > 0.75 THEN 1 ELSE 0 END) as high_domain_count
  FROM mimi_ws_1.cdc.svi_censustract_multiyears
  WHERE svi BETWEEN 0.4 AND 0.6  -- Moderate overall SVI
)

SELECT 
  state_abbr,
  county_name,
  year,
  COUNT(*) as tract_count,
  AVG(high_domain_count) as avg_high_domains,
  AVG(svi) as avg_svi
FROM high_domain_tracts
WHERE high_domain_count >= 2  -- At least 2 domains are high
GROUP BY state_abbr, county_name, year
HAVING COUNT(*) >= 3  -- Only include areas with multiple affected tracts
ORDER BY tract_count DESC, avg_high_domains DESC
LIMIT 20;

-- How it works:
-- 1. Calculates baseline statistics for each vulnerability domain
-- 2. Identifies census tracts with moderate overall SVI but multiple high domain scores
-- 3. Aggregates results by geographic area and year to find patterns
-- 4. Returns top areas with multiple affected tracts

-- Assumptions and Limitations:
-- - Uses 0.75 as threshold for "high" domain scores
-- - Defines "moderate" SVI as between 0.4 and 0.6
-- - Requires at least 3 tracts in an area to be considered significant
-- - Current year data may be incomplete or still being updated

-- Possible Extensions:
-- 1. Add trend analysis to see if these patterns persist over time
-- 2. Include specific domain combinations that most frequently occur together
-- 3. Compare against local healthcare resource availability
-- 4. Add demographic data to understand affected populations better
-- 5. Create geographic clusters of affected areas for regional planning

/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-11-05T23:31:48.154979
    - Additional Notes: This query reveals census tracts that may be overlooked in traditional SVI assessments due to moderate overall scores despite having multiple high-risk domains. The analysis is particularly useful for emergency preparedness teams who need to identify areas that might need more resources than their total SVI score suggests.
    
    */